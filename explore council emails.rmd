---
title: "What do Boulderites Care About?"
subtitle: "An Exploratory Analysis into City Council Emails"
author: "Eric Stern"
date: "8/31/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(tidytext)
library(plotly)
library(DT)

# functions
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

format_table <- function(data) {
  data %>% 
    rename_all(~str_to_title(.) %>% 
                 str_replace_all("_", " ") %>% 
                 str_wrap(width = 30)) %>% 
    knitr::kable()
}
```

# About the Data
This is data that the city of Boulder keeps open to the public. They maintain ~30 data sets for various different areas of interest such as crime, homelessness, and city affairs. This analysis is leveraging the data set, [2019 Council Emails Dataset](https://bouldercolorado.gov/open-data/emails-to-boulder-city-council/):

>Data set containing 2019 emails to council@bouldercolorado.gov. This version works best for viewing in Excel, as it includes only the plain text version of the emails. This file is updated daily with new emails.

```{r}
raw_data <- read_csv("http://www-static.bouldercolorado.gov/docs/opendata/CouncilEmails_PlainText2019.csv")

# raw_data %>% 
#   datatable()
```

# Understanding the Data
This data set has the following columns : `r names(raw_data)`. They are relatively self explanatory. One item to note is that all emails included in this data set are sent to council@bouldercolorado.gov. They may also be sent to others such as boulderplanningboard or specific city council members.

# Data Cleaning
These data are a little messy. Not bad in the grand scheme of data messiness but we need to remove some junk if we want any reasonable results. I have created a table of what I removed and why:
```{r}
removed <- 
  list()
removed$no_reply <- 
  raw_data %>% 
  filter(SentFrom == "No Reply") # these are spam

removed_rows <- 
  bind_rows(removed, .id = "removal_reason")

city_council_members <- 
  c("Jones, Suzanne",
    "Weaver,  Sam",
    "Brockett, Aaron",
    "Yates,  Phillip",
    "Carlisle, Cynthia",
    "Grano, Jill",
    "Morzel, Lisa",
    "Young,  Mary",
    "Nagle, Mirabai")

city_officials <- 
  c("Aulabaugh, Shannon", # police spokesperson
    "Brautigam, Jane") #city manager 

data_clean <- 
  raw_data %>% 
  # remove bad data
  anti_join(removed_rows %>% 
              select(-removal_reason)) %>% 
  # create some flag variables
  mutate(IsMasked = ifelse(str_detect(SentFrom, "\\[*\\]"), T, F),
         IsReply  = ifelse(str_detect(EmailSubject, "^R[E,e]:"), T, F),
         FromCCM  = ifelse(str_detect(SentFrom, 
                                      pattern = str_c(city_council_members, collapse = "|")),
                           T,
                           F),
         ToCCM  = ifelse(str_detect(SentTo, 
                             pattern =  str_c(city_council_members, collapse = "|")),
                           T,
                           F),
         FromCO = ifelse(str_detect(SentFrom, 
                             pattern =  str_c(city_officials, collapse = "|")),
                           T,
                           F)) %>% 
  mutate(ReceivedDate = as_date(ReceivedDate)) 
  


removed_rows %>% 
  group_by(removal_reason) %>% 
  summarise(n_rows_removed = n()) %>% 
  ungroup() %>% 
  format_table()
```


## Metadata 
The meat of this data set is the plain email text body. We'll get to that later. First, let's look at the meta data about whose sending the emails and when they are sending them.

### Senders
My hypothesis is that there aren't too many unique senders. Unfortunately public engagement is low in general. As expected, we see a small handful having set the majority of emails.
```{r}
frequency_email <- data_clean %>% 
  count(SentFrom, FromCCM, FromCO) %>% 
  mutate(FromCCM = case_when(FromCCM ~ "City Council Member", 
                             FromCO  ~ "City Official",
                             T       ~ "Constituent")) %>% 
  arrange(desc(n)) %>% 
  mutate(SentFrom = as_factor(SentFrom)) 

frequency_email %>% 
  plot_ly(x = ~SentFrom, y = ~n, color = ~FromCCM, type = "bar")
```

If we look at some descriptive statistics about whose sending emails and their frequency, we get the following:
```{r}


frequency_email %>% 
  summarise(total_observations = sum(n),
            mean   = mean(n),
            median = median(n),
            mode   = getmode(n),
            max    = max(n),
            min    = min(n)) %>% 
 format_table()
```

As expected, this is a very skewed distribution with most only sending one email and one individual having sent `r pluck(summarise(frequency_email, max = max(n)), 1)`.

## Dates of Emails

```{r}
data_clean %>% 
  count(ReceivedDate) %>% 
  plot_ly(x = ~ReceivedDate, y = ~n, type = 'scatter', mode = 'lines')
  
```


## Email Duplicates
